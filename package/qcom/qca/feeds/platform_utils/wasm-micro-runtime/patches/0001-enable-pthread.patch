From 19a432a7f645da38abe9555177e073e788765f84 Mon Sep 17 00:00:00 2001
From: Adesh Keremane <quic_adeshk@quicinc.com>
Date: Fri, 16 Aug 2024 10:44:13 -0700
Subject: [PATCH] wasm-micro-runtime: propagating from coretech.1.0

propagating the wasm runtime from coretech.1.0 to win.coretech.3.0

Change-Id: I480e26b4673d6563e1b4f7035afcd4f2e3debdd2
Signed-off-by: Adesh Keremane <quic_adeshk@quicinc.com>
---
Index: wasm-micro-runtime-WAMR-1.3.2/CMakeLists.txt
===================================================================
--- wasm-micro-runtime-WAMR-1.3.2.orig/CMakeLists.txt
+++ wasm-micro-runtime-WAMR-1.3.2/CMakeLists.txt
@@ -17,6 +17,10 @@ set (CMAKE_SHARED_LIBRARY_LINK_CXX_FLAGS
 
 set (CMAKE_C_STANDARD 99)
 
+if("${CMAKE_SYSTEM_PROCESSOR}" STREQUAL "arm")
+  set(WAMR_BUILD_TARGET "ARMv7")
+endif()
+
 # Set WAMR_BUILD_TARGET, currently values supported:
 # "X86_64", "AMD_64", "X86_32", "AARCH64[sub]", "ARM[sub]", "THUMB[sub]",
 # "MIPS", "XTENSA", "RISCV64[sub]", "RISCV32[sub]"
@@ -82,7 +86,7 @@ endif ()
 
 if (NOT DEFINED WAMR_BUILD_LIB_PTHREAD)
   # Disable pthread library by default
-  set (WAMR_BUILD_LIB_PTHREAD 0)
+  set (WAMR_BUILD_LIB_PTHREAD 1)
 endif ()
 
 if (NOT DEFINED WAMR_BUILD_LIB_WASI_THREADS)
@@ -154,6 +158,8 @@ if (MINGW)
   target_link_libraries (iwasm_shared -lWs2_32)
 endif ()
 
+ADD_SUBDIRECTORY(product-mini/platforms/linux)
+
 install (TARGETS iwasm_shared LIBRARY DESTINATION lib)
 
 # HEADERS
Index: wasm-micro-runtime-WAMR-1.3.2/product-mini/platforms/linux/CMakeLists.txt
===================================================================
--- wasm-micro-runtime-WAMR-1.3.2.orig/product-mini/platforms/linux/CMakeLists.txt
+++ wasm-micro-runtime-WAMR-1.3.2/product-mini/platforms/linux/CMakeLists.txt
@@ -71,6 +71,8 @@ if (NOT DEFINED WAMR_BUILD_LIBC_WASI)
   set (WAMR_BUILD_LIBC_WASI 1)
 endif ()
 
+set(WAMR_BUILD_LIBC_EMCC 1)
+
 if (NOT DEFINED WAMR_BUILD_FAST_INTERP)
   # Enable fast interpreter
   set (WAMR_BUILD_FAST_INTERP 1)
@@ -83,7 +85,7 @@ endif ()
 
 if (NOT DEFINED WAMR_BUILD_LIB_PTHREAD)
   # Disable pthread library by default
-  set (WAMR_BUILD_LIB_PTHREAD 0)
+  set (WAMR_BUILD_LIB_PTHREAD 1)
 endif ()
 
 if (NOT DEFINED WAMR_BUILD_LIB_WASI_THREADS)
@@ -141,6 +143,11 @@ if (WAMR_BUILD_TARGET MATCHES "X86_.*" O
   endif ()
 endif ()
 
+set (RUNTIME_SOURCE_ALL
+    ${WAMR_ROOT_DIR}/product-mini/platforms/posix/main.c
+    ${UNCOMMON_SHARED_SOURCE}
+)
+
 # The following flags are to enhance security, but it may impact performance,
 # we disable them by default.
 #if (WAMR_BUILD_TARGET MATCHES "X86_.*" OR WAMR_BUILD_TARGET STREQUAL "AMD_64")
Index: wasm-micro-runtime-WAMR-1.3.2/product-mini/platforms/posix/main.c
===================================================================
--- wasm-micro-runtime-WAMR-1.3.2.orig/product-mini/platforms/posix/main.c
+++ wasm-micro-runtime-WAMR-1.3.2/product-mini/platforms/posix/main.c
@@ -6,6 +6,11 @@
 #ifndef _GNU_SOURCE
 #define _GNU_SOURCE
 #endif
+
+#if !defined(BH_HAS_DLFCN)
+#define BH_HAS_DLFCN 1
+#endif
+
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
Index: wasm-micro-runtime-WAMR-1.3.2/wamr-compiler/build_llvm.sh
===================================================================
--- wasm-micro-runtime-WAMR-1.3.2.orig/wamr-compiler/build_llvm.sh
+++ wasm-micro-runtime-WAMR-1.3.2/wamr-compiler/build_llvm.sh
@@ -3,5 +3,8 @@
 # Copyright (C) 2020 Intel Corporation. All rights reserved.
 # SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
 
-/usr/bin/env python3 -m pip install --user -r ../build-scripts/requirements.txt
-/usr/bin/env python3 ../build-scripts/build_llvm.py "$@"
+which python3
+python3 -V
+python3 -m pip install -r ../build-scripts/requirements.txt
+python3 ../build-scripts/build_llvm.py "$@"
+
